@page "/notification-admin"
@inject NotificationService NotificationService
@rendermode InteractiveServer

<PageTitle>알림 관리</PageTitle>

<div class="container mt-4">
    <h2>알림 메시지 관리</h2>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>토스트 알림 보내기</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@notificationModel" OnValidSubmit="@SendNotification">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">제목</label>
                            <InputText class="form-control" @bind-Value="notificationModel.Title" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">메시지</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="notificationModel.Message" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">타입</label>
                            <InputSelect class="form-select" @bind-Value="notificationModel.Type">
                                <option value="info">정보</option>
                                <option value="success">성공</option>
                                <option value="warning">경고</option>
                                <option value="error">오류</option>
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">대상</label>
                            <InputSelect class="form-select" @bind-Value="notificationModel.Target">
                                <option value="all">모든 사용자</option>
                                <option value="user">특정 사용자</option>
                                <option value="group">특정 그룹</option>
                            </InputSelect>
                        </div>

                        @if (notificationModel.Target != "all")
                        {
                            <div class="mb-3">
                                <label class="form-label">@(notificationModel.Target == "user" ? "사용자 ID" : "그룹명")</label>
                                <InputText class="form-control" @bind-Value="notificationModel.TargetId" />
                            </div>
                        }

                        <button type="submit" class="btn btn-primary">알림 보내기</button>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>팝업 메시지 보내기</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@popupModel" OnValidSubmit="@SendPopup">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">제목</label>
                            <InputText class="form-control" @bind-Value="popupModel.Title" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">메시지</label>
                            <InputTextArea class="form-control" rows="3" @bind-Value="popupModel.Message" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">타입</label>
                            <InputSelect class="form-select" @bind-Value="popupModel.Type">
                                <option value="info">정보</option>
                                <option value="success">성공</option>
                                <option value="warning">경고</option>
                                <option value="error">오류</option>
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">대상</label>
                            <InputSelect class="form-select" @bind-Value="popupModel.Target">
                                <option value="all">모든 사용자</option>
                                <option value="user">특정 사용자</option>
                            </InputSelect>
                        </div>

                        @if (popupModel.Target == "user")
                        {
                            <div class="mb-3">
                                <label class="form-label">사용자 ID</label>
                                <InputText class="form-control" @bind-Value="popupModel.TargetId" />
                            </div>
                        }

                        <button type="submit" class="btn btn-warning">팝업 보내기</button>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>빠른 테스트</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary" @onclick="SendInfoNotification">
                            정보 알림
                        </button>
                        <button class="btn btn-outline-success" @onclick="SendSuccessNotification">
                            성공 알림
                        </button>
                        <button class="btn btn-outline-warning" @onclick="SendWarningNotification">
                            경고 알림
                        </button>
                        <button class="btn btn-outline-danger" @onclick="SendErrorNotification">
                            오류 알림
                        </button>
                        <button class="btn btn-outline-secondary" @onclick="SendQuickPopup">
                            테스트 팝업
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private NotificationModel notificationModel = new();
    private PopupModel popupModel = new();

    private async Task SendNotification()
    {
        try
        {
            switch (notificationModel.Target)
            {
                case "all":
                    await NotificationService.SendNotificationToAll(
                        notificationModel.Title,
                        notificationModel.Message,
                        notificationModel.Type);
                    break;
                case "user":
                    await NotificationService.SendNotificationToUser(
                        notificationModel.TargetId,
                        notificationModel.Title,
                        notificationModel.Message,
                        notificationModel.Type);
                    break;
                case "group":
                    await NotificationService.SendNotificationToGroup(
                        notificationModel.TargetId,
                        notificationModel.Title,
                        notificationModel.Message,
                        notificationModel.Type);
                    break;
            }

            // 폼 초기화
            notificationModel = new();
        }
        catch (Exception ex)
        {
            // 오류 처리
            Console.WriteLine($"알림 전송 오류: {ex.Message}");
        }
    }

    private async Task SendPopup()
    {
        try
        {
            switch (popupModel.Target)
            {
                case "all":
                    await NotificationService.SendPopupToAll(
                        popupModel.Title,
                        popupModel.Message,
                        popupModel.Type);
                    break;
                case "user":
                    await NotificationService.SendPopupToUser(
                        popupModel.TargetId,
                        popupModel.Title,
                        popupModel.Message,
                        popupModel.Type);
                    break;
            }

            // 폼 초기화
            popupModel = new();
        }
        catch (Exception ex)
        {
            // 오류 처리
            Console.WriteLine($"팝업 전송 오류: {ex.Message}");
        }
    }

    private async Task SendInfoNotification()
    {
        await SendQuickNotification("info");
    }

    private async Task SendSuccessNotification()
    {
        await SendQuickNotification("success");
    }

    private async Task SendWarningNotification()
    {
        await SendQuickNotification("warning");
    }

    private async Task SendErrorNotification()
    {
        await SendQuickNotification("error");
    }

    private async Task SendQuickNotification(string type)
    {
        var titles = new Dictionary<string, string>
            {
                ["info"] = "정보",
                ["success"] = "성공",
                ["warning"] = "경고",
                ["error"] = "오류"
            };

        var messages = new Dictionary<string, string>
            {
                ["info"] = "이것은 정보 알림입니다.",
                ["success"] = "작업이 성공적으로 완료되었습니다.",
                ["warning"] = "주의가 필요한 상황입니다.",
                ["error"] = "오류가 발생했습니다."
            };

        try
        {
            Console.WriteLine($"알림 전송 시작: {type}");
            await NotificationService.SendNotificationToAll(titles[type], messages[type], type);
            Console.WriteLine($"알림 전송 완료: {type}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"알림 전송 오류: {ex.Message}");
        }
    }

    private async Task SendQuickPopup()
    {
        await NotificationService.SendPopupToAll("테스트 팝업", "이것은 테스트 팝업 메시지입니다.", "info");
    }

    private class NotificationModel
    {
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public string Type { get; set; } = "info";
        public string Target { get; set; } = "all";
        public string TargetId { get; set; } = "";
    }

    private class PopupModel
    {
        public string Title { get; set; } = "";
        public string Message { get; set; } = "";
        public string Type { get; set; } = "info";
        public string Target { get; set; } = "all";
        public string TargetId { get; set; } = "";
    }
}